<!DOCTYPE html>
<html>
<head>
    <title>ä½¿ç”¨ Docker swarm æ„å»º PostgreSQL é›†ç¾¤ // Svtter&#39;s Blog</title>

    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    
    

        <meta property="og:title" content="ä½¿ç”¨ Docker swarm æ„å»º PostgreSQL é›†ç¾¤" />
    <meta property="og:description" content="" />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="en" />
    <meta property="og:url" content="https://svtter.cn/2018/12/01/%E4%BD%BF%E7%94%A8-docker-swarm-%E6%9E%84%E5%BB%BA-postgresql-%E9%9B%86%E7%BE%A4/" />
    

    <link rel="shortcut icon" href="/favicon.ico">

    <link href="https://svtter.cn/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
    <link href="https://svtter.cn/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="https://svtter.cn/css/style.css">
    

    <meta name="generator" content="Hugo 0.84.3" />
</head>


<body>
<div id="container">
    <header id="header">
    <div id="header-outer" class="outer">
        <div id="header-inner" class="inner">
            <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
            <a id="logo" class="logo-text" href="https://svtter.cn/">Svtter&#39;s Blog</a>
            <nav id="main-nav">
                
                <a class="main-nav-link" href="/categories/">ğŸ“° Categories</a>
                
                <a class="main-nav-link" href="/daily-ml/">âš™ï¸ Daily ML</a>
                
                <a class="main-nav-link" href="/tags/">ğŸ·ï¸ Tags</a>
                
                <a class="main-nav-link" href="/about/">ğŸ™â€â™‚ï¸ About</a>
                
            </nav>
            <nav id="sub-nav">
                <div id="search-form-wrap">
                </div>
            </nav>
        </div>
    </div>
</header>

    <section id="main" class="outer">
        <article class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            <h1 class="article-title" itemprop="name">ä½¿ç”¨ Docker swarm æ„å»º PostgreSQL é›†ç¾¤</h1>
        </header>
        
        <div class="article-meta">
            <a href="/2018/12/01/%E4%BD%BF%E7%94%A8-docker-swarm-%E6%9E%84%E5%BB%BA-postgresql-%E9%9B%86%E7%BE%A4/" class="article-date">
                <time datetime='2018-12-01T01:00:00.000&#43;08:00' itemprop="datePublished">2018-12-01</time>
            </a>
            
            
            <div class="post-categories">
                <div class="article-category">
                    
                    
                    <a class="article-category-link" href="https://svtter.cn//categories/devops">DevOps</a>
                    
                </div>
            </div>
            
            
            <div class="article-comment-link-wrap">
                <a href="/2018/12/01/%E4%BD%BF%E7%94%A8-docker-swarm-%E6%9E%84%E5%BB%BA-postgresql-%E9%9B%86%E7%BE%A4/#disqus_thread" class="article-comment-link">Comments</a>
            </div>
            
        </div>
        <div class="article-entry" itemprop="articleBody">
            <blockquote>
<p>åˆæ˜¯ä¸€ä¸ªæ¸£ç¿»ï¼ŒCopyright belongs to the original textã€‚</p>
<p><a href="https://info.crunchydata.com/blog/an-easy-recipe-for-creating-a-postgresql-cluster-with-docker-swarm">åŸæ–‡åœ°å€</a></p>
</blockquote>
<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>PostgreSQL åœ¨ 9.0 ç‰ˆæœ¬å·²ç»å¼€å§‹æŒç»­æ¥æ”¶å¤§é‡çš„å¢å¼ºï¼ŒåŒ…æ‹¬ï¼š</p>
<ol>
<li>å¼‚æ­¥æ‹“å±•</li>
<li>åŒæ­¥æ‹“å±•</li>
<li>ä»²è£æäº¤</li>
<li>çº§è”æ‹“å±•</li>
<li>é€»è¾‘æ‹“å±•</li>
</ol>
<p>PostgreSQL æ–‡æ¡£ä¹Ÿæä¾›äº†ä¸€ä¸ª overview ä»¥åŠ ä¸åŒæ‹“å±•æ–¹æ³•çš„æ¯”è¾ƒã€‚è¯¦è§<!-- raw HTML omitted -->PostgreSQL é›†ç¾¤ç­–ç•¥æ¯”è¾ƒ<!-- raw HTML omitted --></p>
<p>ç”¨äºéƒ¨ç½² PostgreSQL çš„æ‹“å±•çš„ä¸»æ‹“å±•çš„æ–¹æ³•è®ºï¼Œæ˜¯ä¸€ä¸ªé‡è¦çš„å·¥å…·æ¥ä¸ºä½ çš„æ•°æ®åº“é›†ç¾¤åˆ›å»ºé«˜å¯ç”¨çš„ç¯å¢ƒã€‚éœ€è¦ä¸€ä¸ªåˆé€‚çš„éƒ¨ç½²ç­–ç•¥æ¥ç¡®ä¿ä½ çš„æ•°æ®è¢«ä¿å­˜åˆ°ä¸åŒç£ç›˜ï¼Œä»¥åŠä¸åŒçš„æ•°æ®ä¸­å¿ƒã€‚</p>
<p>æ‹“å±•ä¸æ˜¯ä¸€ä¸ªâ€œå®‰è£…ç„¶åå¿˜è®°â€çš„æ“ä½œã€‚åœ¨ç”Ÿäº§ç³»ç»Ÿä¸­ï¼Œä½ æƒ³è¦ç¡®å®šä½ å¯¹å®ä¾‹æœ‰åˆé€‚çš„ç›‘æ§ï¼Œæ¥äº†è§£ä½ æ‰€æœ‰çš„åœ¨çº¿çš„æ‹“å±•ï¼Œæˆ–è€…äº†è§£ä¸€ä¸ªæ‹“å±•æœ‰å¤šå°‘æ•°æ®éœ€è¦ä¸ä¸»èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥ã€‚</p>
<p>å½“ä¸»èŠ‚ç‚¹é…ç½®å¥½ä»¥åï¼Œå®‰è£…å°±å¾ˆå®¹æ˜“äº†ã€‚ä½†å¹¸è¿çš„æ˜¯ï¼Œä½¿ç”¨ Docker å¯ä»¥ä½¿å¾—è¿™ä¸ªè¿‡ç¨‹æ›´åŠ è½»æ¾ã€‚</p>
<h2 id="ç¯å¢ƒå®‰è£…">ç¯å¢ƒå®‰è£…</h2>
<p>æƒ³è¦éƒ¨ç½²è¿™ä¸ªç¯å¢ƒï¼Œä½ è‡³å°‘éœ€è¦ Docker 1.12ç‰ˆæœ¬ã€‚</p>
<p>è¦æƒ³å¼€å§‹ï¼Œæä¾›ä¸€ä¸ª Docker é›†ç¾¤ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¼€å‘é›†ç¾¤ï¼Œä½ å¯ä»¥åœ¨æ¯ä¸€ä¸ªæœºå™¨ä¸ŠåŠ è½½ Dokcerï¼Œæ¥ä½¿ç”¨ Swarmã€‚è¿™ä¸ªæ–¹æ³•å°†ä½¿ç”¨å¦‚ä¸‹çš„æ¶æ„ï¼š</p>
<p><!-- raw HTML omitted --></p>
<p>æ¯ä¸€ä¸ªç³»ç»Ÿéƒ½éœ€è¦å®‰è£… Docker ä»¥åŠå¯åŠ¨ã€‚</p>
<h2 id="swarm-å®‰è£…">Swarm å®‰è£…</h2>
<p>ä»1.12ç‰ˆæœ¬å¼€å§‹ï¼ŒDockerå°±å·²ç»é›†æˆäº†Swarmã€‚</p>
<h2 id="å®¹å™¨ç¼–æ’">å®¹å™¨ç¼–æ’</h2>
<p>é«˜å¯ç”¨ PostgresSQL é›†ç¾¤é…ç½®éœ€è¦ä¸¤ä¸ªä»¥ä¸Šçš„ä¸»æœºã€‚ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹éœ€è¦è¿è¡Œåœ¨ä¸åŒçš„ worker èŠ‚ç‚¹ä¸Šï¼Œæ¥ä½¿å¾—å¯ç”¨æ€§æœ€é«˜ã€‚</p>
<p>ä¸ºäº†éƒ¨ç½² <!-- raw HTML omitted -->Crunchy PostgreSQL containers<!-- raw HTML omitted --> åˆ°å¤šä¸ªé›†ç¾¤ï¼Œä½ éœ€è¦ä½¿ç”¨ node labelsã€‚</p>
<p>æ ‡æ³¨ä¸»æœºå¯¹äºä½¿ç”¨ PostgreSQL å®¹å™¨æœ‰å‡ ä¸ªå¥½å¤„ï¼š</p>
<ul>
<li>å°†æœåŠ¡æ•£æ­¥åˆ°è®¸å¤š worker ä¸Šï¼Œæ¥æé«˜å¯ç”¨æ€§</li>
<li>ä¸»æœºå¯ä»¥é’ˆå¯¹è¯»ï¼ˆä»ï¼‰å†™ï¼ˆä¸»ï¼‰æ“ä½œè¿›è¡Œä¼˜åŒ–ï¼ˆä¾‹å¦‚ä½¿ç”¨é«˜æ€§èƒ½ç£ç›˜ï¼‰</li>
</ul>
<p>**è®°ä½ï¼š**å¯¹äºPostgreSQL 10ï¼Œä¸»èŠ‚ç‚¹å¯ä»¥åŒæ—¶è¢«å…è®¸è¯»å†™ï¼Œä½†æ˜¯ä»èŠ‚ç‚¹ä»…ä»…å…è®¸è¢«è¯»ã€‚</p>
<p>ä¸ºäº†å…è®¸å®¹å™¨è¢«æ”¾åœ¨æŒ‡å®šçš„ worker èŠ‚ç‚¹ä¸Šï¼Œå¢åŠ ä¸€ä¸ªå…ƒæ•°æ®æ ‡ç­¾åˆ° Swarm èŠ‚ç‚¹ä¸Šã€‚</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œä¸€ä¸ªè¢«ç§°ä¸º primary çš„æ ‡ç­¾ï¼ŒåŠ å…¥äº† worker1ã€‚é€šè¿‡ä½¿ç”¨è¿™ä¸ªæ ‡ç­¾ï¼Œæˆ‘ä»¬å¯ä»¥åº”ç”¨ä¸€äº›çº¦æŸåˆ° Docker swarm çš„ PostgreSQL Stack éƒ¨ç½²ä¸Šã€‚</p>
<p><strong>æ³¨æ„ï¼šæˆ‘ä»¬æ²¡æœ‰å¯¹ä»èŠ‚ç‚¹å¢åŠ çº¦æŸï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„ä½¿ç”¨ä¸€æ¡ inverse çº¦æŸï¼š</strong></p>
<p><code>node.labels.type != primary</code></p>
<h2 id="postgresql-stack-å®šä¹‰">PostgreSQL stack å®šä¹‰</h2>
<p>é€šè¿‡ Swarm éƒ¨ç½²ä»¥åŠ worker èŠ‚ç‚¹æ­£ç¡®çš„æ ‡è®°ï¼Œæˆ‘ä»¬å¯ä»¥éƒ¨ç½² PostgreSQL stackäº†ã€‚</p>
<p>PostgreSQL stack æ˜¯é€šè¿‡ä¸€ä¸ªä¸»èŠ‚ç‚¹ä»¥åŠä»èŠ‚ç‚¹ç»„æˆçš„ã€‚ä¸‹é¢æ˜¯æœåŠ¡å®šä¹‰ï¼š</p>
<p><em>docker-compose.yml</em></p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>æ³¨æ„ï¼Œä¸»æœåŠ¡å®šä¹‰äº†ä¸€ä¸ª hostnameï¼Œä½†æ˜¯ replica æœåŠ¡æ²¡æœ‰ã€‚Replica éœ€è¦ä¸€ä¸ª hostname æ¥å¯åŠ¨ replicationã€‚é€šè¿‡æä¾›ä¸€ä¸ªé™æ€çš„ hostname ç»™ä¸»èŠ‚ç‚¹ï¼Œreplicaå°±å¯ä»¥è¿æ¥ä¸»èŠ‚ç‚¹ï¼Œè€Œä¸éœ€è¦å‘ç°ä¸»å®¹å™¨ã€‚</p>
<p>replicaï¼Œæ²¡æœ‰ä¸€ä¸ª hostnameï¼Œè¿™å…è®¸ replica æœåŠ¡æ‹“å±•åˆ°å¤šä¸ªèŠ‚ç‚¹ã€‚ï¼ˆå¾…ä¼šå„¿å±•ç¤ºä¸€ä¸‹ï¼‰ã€‚</p>
<p>primary å’Œ replica æœåŠ¡çš„ä¸»è¦åŒºåˆ«ï¼Œæ˜¯ PG_MODE ç¯å¢ƒå˜é‡ã€‚è¿™ä¸ªå˜é‡é…ç½®å®¹å™¨æ˜¯ä¸»èŠ‚ç‚¹ï¼Œè¿˜æ˜¯ä»èŠ‚ç‚¹ã€‚</p>
<h2 id="éƒ¨ç½²-stack">éƒ¨ç½² STACK</h2>
<p>ä¿å­˜è¿™ä¸ªæ–‡ä»¶åˆ°Â _docker-compose.ymlÂ _ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Docker è¿›è¡Œéƒ¨ç½²äº†ã€‚</p>
<!-- raw HTML omitted -->
<p>è¿™ä¸ª stack éƒ¨ç½²ï¼Œå°†ä¼šåˆ›å»ºä¸€ä¸ª PostgreSQL é›†ç¾¤ï¼Œå°±åƒæ˜¯ä¸‹å›¾ä¸€æ ·ï¼š</p>
<p><strong><!-- raw HTML omitted --></strong></p>
<h2 id="æµ‹è¯•é›†ç¾¤">æµ‹è¯•é›†ç¾¤</h2>
<p>æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>å¦‚æœæƒ³è¦æå‡ replicas çš„æ•°é‡ï¼Œè¿è¡Œä¸‹åˆ—å‘½ä»¤ï¼š</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>ä¸ºäº†ç¡®ä¿ replicas æ˜¯æµå¼çš„ï¼Œåœ¨ worker1 èŠ‚ç‚¹ä¸ŠæŸ¥è¯¢ PostgreSQL ä¸»èŠ‚ç‚¹ï¼Œä½¿ç”¨ä¸‹åˆ—å‘½ä»¤ï¼š</p>
<pre><code>docker exec -it $(docker ps -q) psql -U postgres -x -c 'table pg_stat_replication' postgres
</code></pre>
<h2 id="ç¤ºä¾‹ä»£ç ">ç¤ºä¾‹ä»£ç </h2>
<p>ä¸‹é¢æ˜¯å®ä¾‹ä»£ç ï¼š</p>
<p><a href="https://github.com/CrunchyData/crunchy-containers/tree/master/examples/docker/swarm-service">https://github.com/CrunchyData/crunchy-containers/tree/master/examples/docker/swarm-service</a></p>
<h2 id="ç»“è®º">ç»“è®º</h2>
<p>Docker ä»¥åŠ Docker swarm æä¾›äº†å·¥å…·ï¼Œæ¥ä½¿å¾—å®¹å™¨éƒ¨ç½²è¿›å…¥äº†æ›´é«˜çš„å±‚æ¬¡ã€‚æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªæè®®è¯æ˜äº† PostgreSQL é›†ç¾¤æ˜¯å¦‚ä½•çš„å®¹æ˜“éƒ¨ç½²ã€‚</p>
        </div>

        
        
        <div class="article-toc" >
            <h3>Contents</h3>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#èƒŒæ™¯">èƒŒæ™¯</a></li>
    <li><a href="#ç¯å¢ƒå®‰è£…">ç¯å¢ƒå®‰è£…</a></li>
    <li><a href="#swarm-å®‰è£…">Swarm å®‰è£…</a></li>
    <li><a href="#å®¹å™¨ç¼–æ’">å®¹å™¨ç¼–æ’</a></li>
    <li><a href="#postgresql-stack-å®šä¹‰">PostgreSQL stack å®šä¹‰</a></li>
    <li><a href="#éƒ¨ç½²-stack">éƒ¨ç½² STACK</a></li>
    <li><a href="#æµ‹è¯•é›†ç¾¤">æµ‹è¯•é›†ç¾¤</a></li>
    <li><a href="#ç¤ºä¾‹ä»£ç ">ç¤ºä¾‹ä»£ç </a></li>
    <li><a href="#ç»“è®º">ç»“è®º</a></li>
  </ul>
</nav>
        </div>
        
        

        


        
        <footer class="article-footer">
            <ul class="article-tag-list">
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://svtter.cn//tags/container">Container
                    </a>
                </li>
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://svtter.cn//tags/docker">Docker
                    </a>
                </li>
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://svtter.cn//tags/swarm">Swarm
                    </a>
                </li>
                
            </ul>
        </footer>
        
    </div>
    
<nav id="article-nav">
    
    <a href="/2018/12/06/%E8%BF%81%E7%A7%BB-django-model-id-%E4%B8%BA-uuid/" id="article-nav-newer" class="article-nav-link-wrap">
        <div class="article-nav-title"><span>&lt;</span>&nbsp;
            è¿ç§» Django Model id ä¸º uuid
        </div>
    </a>
    
    
    <a href="/2018/11/23/beam-search-%E4%B8%80%E4%B8%AA%E6%90%9C%E7%B4%A2%E7%AD%96%E7%95%A5/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">beam search â€“ ä¸€ä¸ªæœç´¢ç­–ç•¥&nbsp;<span>&gt;</span></div>
    </a>
    
</nav>


</article>

        
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "svtter-cn" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
    </section>
    <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2021 Svtter&#39;s Blog
            <br />
            Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with theme <a href="https://github.com/carsonip/hugo-theme-minos" target="_blank">Minos</a>
        </div>
    </div>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-90439158-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css" integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    <script>
        document.getElementById('main-nav-toggle').addEventListener('click', function () {
            var header = document.getElementById('header');
            if (header.classList.contains('mobile-on')) {
                header.classList.remove('mobile-on');
            } else {
                header.classList.add('mobile-on');
            }
        });
    </script>
</footer>

</div>
</body>
</html>
